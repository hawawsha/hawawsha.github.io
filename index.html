<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سوق باي - souq-pi-app</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        header { background-color: #333; color: white; padding: 1rem; text-align: center; }
        .content { padding: 20px; text-align: center; }
        #pay-button { padding: 15px 30px; background-color: #f39c12; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; display: block; margin: 20px auto; }
    </style>
</head>
<body>

<header>
    <h2>سوق باي</h2>
</header>

<div class="content">
    <h1>مرحباً بك في تطبيق سوق باي</h1>
    <p>بوابتك لإتمام الخطوة العاشرة بنجاح.</p>
    <img src="iphone.jpg" alt="iPhone" style="max-width: 200px; margin-top: 20px;">
    <button id="pay-button">شراء المنتج (1 Pi)</button>
</div>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script>
    const Pi = window.Pi;
    // تفعيل الـ Sandbox وتحديد الإصدار
    Pi.init({ version: "2.0", sandbox: true }); 

    document.getElementById('pay-button').onclick = async function() {
        try {
            // إضافة طلب الصلاحيات برمجياً لتخطي رسالة payments scope
            const payment = await Pi.createPayment({
                amount: 1,
                memo: "اختبار إتمام الخطوة 10",
                metadata: { productId: "test-item-001" }
            }, {
                onReadyForServerApproval: (paymentId) => {
                    // الربط مع ملف الـ api الذي أنشأناه
                    return fetch('/api/index', { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentId })
                    });
                },
                onReadyForServerCompletion: (paymentId, txid) => {
                    alert("تمت العملية بنجاح! رقم التأكيد: " + txid);
                },
                onCancel: (paymentId) => { console.log("تم إلغاء الدفع"); },
                onError: (error) => { alert("خطأ في الربط: " + error.message); }
            });
        } catch (err) {
            // في حال طلب الصلاحيات لأول مرة
            if (err.message.includes("scope")) {
                alert("يرجى المحاولة مرة أخرى، النظام يقوم بتحديث الصلاحيات.");
                Pi.authenticate(['payments'], (paymentId) => {});
            } else {
                alert("تنبيه: " + err.message);
            }
        }
    };
</script>
</body>
</html>
