<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إصلاح شامل للخطوة 10</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
    <div style="text-align:center; padding-top:50px; font-family:sans-serif;">
        <h2>جاري فحص العمليات المعلقة...</h2>
        <p id="status">يرجى الانتظار، نحن نقوم بإغلاق الدفع القديم الآن.</p>
    </div>

    <script>
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: false });

        async function fixPending() {
            const statusBox = document.getElementById('status');
            try {
                await Pi.authenticate(['payments']);
                
                // هذه هي الوظيفة السحرية لإيجاد أي دفع لم يكتمل وإغلاقه
                Pi.createPayment({
                    amount: 1,
                    memo: "Fixing Step 10",
                    metadata: { step: "10" }
                }, {
                    onIncompletePaymentFound: (payment) => {
                        statusBox.innerText = "تم العثور على دفع معلق! جاري إغلاقه...";
                        // إرسال رقم الدفع المعلق للسيرفر لإتمامه فوراً
                        fetch('/api/index', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ paymentId: payment.identifier, action: "complete" })
                        });
                    },
                    onReadyForServerApproval: (paymentId) => { /* ... */ },
                    onReadyForServerCompletion: (paymentId, txid) => {
                        statusBox.innerText = "✅ تم حل المشكلة! الخطوة 10 ستصبح خضراء الآن.";
                    },
                    onCancel: (paymentId) => { },
                    onError: (error) => { statusBox.innerText = "الحالة: " + error.message; }
                });
            } catch (err) {
                statusBox.innerText = "تأكد من فتح الرابط داخل Pi Browser.";
            }
        }
        fixPending();
    </script>
</body>
</html>
